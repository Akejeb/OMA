# Biclustering

```{r setup, echo=FALSE, results="asis"}
library(rebook)
chapterPreamble()
```

Biclustering is a clustering method, which simultaneously clusters rows and columns.
The idea is to find clusters where subset of features share similar pattern 
over subset of samples. 

There are multiple biclustering packages available, In this example, we use
-   [biclust](https://cran.r-project.org/web/packages/biclust/index.html).

Other available packages include, for example:
-   [cobiclust](https://besjournals.onlinelibrary.wiley.com/doi/abs/10.1111/2041-210X.13582).

Load example data
```{r load-pkg-data}
library(mia)
data("enterotype", package="mia")
tse <- enterotype

tse
```

Subset data so that it does not include that many features and samples. 

```{r biclusering_1}
# Subset data so that rarest taxa re filtered out
tse <- subsetByPrevalentTaxa(tse, rank = "Genus", prevalence = 0.2, detection = 0.001)
# Subset data so that only adult patients are included
tse <- tse[, tse$Age > 18 & tse$Age < 60 & !is.na(tse$Age)]

tse
```

Load required package

```{r biclusering_2}
# Load package
if(!require(biclust)){
    install.packages("biclust")
    library(biclust)
}
```

Find biclusters using _biclust_.

```{r biclusering_3}
# Transform assay, Z-transformed assay is for heatmap
tse <- transformSamples(tse, method = "clr", pseudocount = 1)
tse <- transformFeatures(tse, abund_values = "clr", method = "z", name = "clr_z")

# Get assays
assay_clr <- assay(tse, "clr")
assay <- assay(tse, "clr_z")

# Find biclusters
bc <- biclust(assay_clr, method=BCPlaid(), fit.model = y ~ m,
              background = TRUE, shuffle = 100, back.fit = 0, max.layers = 10,
              iter.startup = 10, iter.layer = 100, verbose = FALSE)

bc
```

Create data frames which includes information about which cluster each feature/sample
belongs.

```{r biclusering_4}
# Get cluster info for features
bicluster_features <- bc@RowxNumber
bicluster_features <- data.frame(bicluster_features)
# If no clusters were found, create one
if( nrow(bicluster_features) != nrow(assay) ){
    bicluster_features <- data.frame(cluster = rep(TRUE, nrow(assay)))
} else {
    vec <- ifelse(rowSums(bicluster_features) > 0, FALSE, TRUE)
         
     if ( any(vec) ){
         bicluster_features <- cbind(bicluster_features, vec)
     }
}
rownames(bicluster_features) <- rownames(assay)
colnames(bicluster_features) <- paste0("cluster_", 1:ncol(bicluster_features))

head(bicluster_features)
```

```{r biclusering_5}
# Get cluster information for samples
bicluster_samples <- t(bc@NumberxCol)
bicluster_samples <- data.frame(bicluster_samples)
# If no clusters were found, create one
if( nrow(bicluster_samples) != ncol(assay) ){
    bicluster_samples <- data.frame(cluster = rep(TRUE, ncol(assay)))
} else {
     vec <- ifelse(rowSums(bicluster_samples) > 0, FALSE, TRUE)
         
     if ( any(vec) ){
         bicluster_samples <- cbind(bicluster_samples, vec)
     }

}
rownames(bicluster_samples) <- colnames(assay)
colnames(bicluster_samples) <- paste0("cluster_", 1:ncol(bicluster_samples))

head(bicluster_samples)
```

For plotting, we use _ggplot2_. If you want to use for example _pheatmap_, you can find
example from [here](https://microbiome.github.io/OMA/microbiome-community.html#composition-heatmap).

```{r biclusering_6}
if(!require(ggplot2)){
    install.packages("ggplot2")
    library(ggplot2)
}
```

Create an annotation plot for features.

```{r biclusering_7}

df <- t(data.frame(values = colnames(bicluster_features)))

df <- df[rep(seq_len(nrow(df)), each = nrow(bicluster_features)), , drop = FALSE]
colnames(df) <- paste0(colnames(bicluster_features), "_name")

bicluster_features <- cbind(bicluster_features, df)

bicluster_features$feature <- factor(rownames(bicluster_features), levels = rownames(bicluster_features))

row_annotation <- ggplot(bicluster_features) + coord_equal(ratio = 1) + 
    scale_fill_manual(breaks = c(TRUE, FALSE), values=c("red", "white"), expand = c(0,0))


for( cluster in colnames(bicluster_features) ){
  if (cluster != "feature" && !grepl("_name", cluster)){
    row_annotation <- row_annotation + geom_tile(aes_string(paste0(cluster, "_name"), "feature", fill = cluster)) +
      theme(
        # axis.title.y=element_blank(),
        #     axis.text.y=element_blank(),
        #     axis.ticks.y=element_blank(),
             axis.title.x=element_blank(),
             axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        #     axis.text.x=element_blank(),
        #     axis.ticks.x=element_blank(),
            
            plot.margin=margin(0,0,0,0),
            # legend.position = "none"
            ) +
      labs(fill = "Clusters")
  }
}

row_annotation
```

Create an annotation plot for samples. 
```{r biclusering_8}

df <- t(data.frame(values = colnames(bicluster_samples)))

df <- df[rep(seq_len(nrow(df)), each = nrow(bicluster_samples)), , drop = FALSE]
colnames(df) <- paste0(colnames(bicluster_samples), "_name")

bicluster_samples <- cbind(bicluster_samples, df)

bicluster_samples$sample <- factor(rownames(bicluster_samples), levels = rownames(bicluster_samples))

col_annotation <- ggplot(bicluster_samples) + coord_equal(ratio = 1) + 
    scale_y_discrete(position = "right", expand = c(0,0)) + 
    scale_fill_manual(breaks = c(TRUE, FALSE), values=c("red", "white"))

for( cluster in colnames(bicluster_samples) ){
  if (cluster != "sample" && !grepl("_name", cluster)){
    col_annotation <- col_annotation + geom_tile(aes_string("sample", paste0(cluster, "_name"), fill = cluster)) +
      theme(
        axis.title.y=element_blank(),
        #     axis.text.y=element_blank(),
        #     axis.ticks.y=element_blank(),
            axis.title.x=element_blank(),
            axis.text.x=element_blank(),
            axis.ticks.x=element_blank(),
            
            plot.margin=margin(0,0,0,0),
            legend.position = "none") +
      labs(fill = "Clusters") 
    
    
  }
}

col_annotation 
```

```{r biclusering_9}
if(!require(reshape2)){
    install.packages("reshape2")
    library(reshape2)
}
```

Create a heatmap.

```{r biclusering_11}
data <- melt(assay)
colnames(data) <- c("Feature", "Sample", "Value")

# Determines the scaling of colours
maxval <- round(max(abs(data$Value)))
limits <- c(-maxval, maxval)
breaks <- seq(from = min(limits), to = max(limits), by = 0.5)
colours <- c("darkblue", "blue", "white", "red", "darkred")

heatmap <- ggplot(data) + geom_tile(aes(Sample, Feature, fill = Value)) + 
  theme(
    axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        # axis.title.x=element_blank(),
        # axis.text.x=element_blank(),
        # axis.ticks.x=element_blank(),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        
        plot.margin=margin(0,0,0,0),
       # legend.position = "none"
    legend.key.height= unit(1, 'cm')
        ) +
  scale_fill_gradientn(name = "CLR + Z transform", 
                       breaks = breaks, limits = limits, colours = colours)


heatmap
```

We are using _patchwork_ to combine individual plots together.
```{r biclusering_12}
if(!require(patchwork)){
    install.packages("patchwork")
    library(patchwork)
}
```

We can adjust position of each plot. 

```{r biclusering_13}
design <- c(
  area(2, 1, 3, 1),
  area(2, 2, 3, 3),
  area(1, 2, 1, 3)
)

plot(design)
```

Lastly, we cna combine plots using specified layout. 

```{r biclusering_14, fig.width=10, fig.height=8}
bicluster_plot <- row_annotation + heatmap + col_annotation + 
    plot_layout(design = design, guides = "collect",
                # Adjust widths and heights to align plots.
                # When annotation plot is larger, it might not fit into its column/row.
                # Then you need to make column/row larger.
                
                # Relative widths and heights of each column and row:
                # Currently, the width of the first column is 15 % and the height of the 
                # first row is 25 % the size of others
                
                # To get this work most of the times, you can adjust all sizes to be 1, i.e. equal, 
                # but then the gaps between plots are larger.
                widths = c(0.15, 1, 1),
                heights = c(0.25, 1, 1))

bicluster_plot
```


## Session Info {-}

```{r sessionInfo, echo=FALSE, results='asis'}
prettySessionInfo()
```
